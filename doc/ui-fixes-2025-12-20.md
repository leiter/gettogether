# UI Fixes - 2025-12-20

## Summary

Fixed three UI issues in the ChatScreen:
1. Bottom padding not honoring system UI when keyboard is hidden
2. Added long-press to delete conversation with confirmation dialog
3. Fixed message author detection (`isFromMe`) to correctly identify user's own messages

---

## Fix 1: Bottom System UI Padding

### Problem
The ChatScreen's message input area didn't respect the system navigation bar at the bottom when the keyboard was hidden, causing the input field to be partially obscured.

### Solution
Added `navigationBarsPadding()` modifier to the MessageInput component in addition to the existing `imePadding()`:

**File**: `shared/src/commonMain/kotlin/com/gettogether/app/ui/screens/chat/ChatScreen.kt`

```kotlin
bottomBar = {
    MessageInput(
        // ...
        modifier = Modifier
            .navigationBarsPadding()  // ← Added this
            .imePadding()
    )
}
```

This ensures proper padding whether the keyboard is shown or hidden.

---

## Fix 2: Long-Press to Delete Conversation

### Problem
No way to delete a conversation thread from within the ChatScreen.

### Solution
Implemented long-press on the TopAppBar title to show a delete confirmation dialog.

**Files Modified**:
- `shared/src/commonMain/kotlin/com/gettogether/app/ui/screens/chat/ChatScreen.kt`
- `shared/src/commonMain/kotlin/com/gettogether/app/presentation/viewmodel/ChatViewModel.kt`

**Implementation**:

1. **Added imports** for `combinedClickable`, `AlertDialog`, and state management:
```kotlin
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.combinedClickable
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.TextButton
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
```

2. **Added dialog state**:
```kotlin
var showDeleteDialog by remember { mutableStateOf(false) }
```

3. **Added long-press handler to TopAppBar title**:
```kotlin
Row(
    verticalAlignment = Alignment.CenterVertically,
    modifier = Modifier.combinedClickable(
        onClick = { },
        onLongClick = { showDeleteDialog = true }
    )
) {
    // ... title content
}
```

4. **Added confirmation dialog**:
```kotlin
if (showDeleteDialog) {
    AlertDialog(
        onDismissRequest = { showDeleteDialog = false },
        title = { Text("Delete Conversation") },
        text = { Text("Are you sure you want to delete this conversation? This action cannot be undone.") },
        confirmButton = {
            TextButton(
                onClick = {
                    viewModel.deleteConversation()
                    showDeleteDialog = false
                    onNavigateBack()
                }
            ) {
                Text("Delete", color = MaterialTheme.colorScheme.error)
            }
        },
        dismissButton = {
            TextButton(onClick = { showDeleteDialog = false }) {
                Text("Cancel")
            }
        }
    )
}
```

5. **Added deleteConversation function to ChatViewModel**:
```kotlin
fun deleteConversation() {
    viewModelScope.launch {
        try {
            val accountId = accountRepository.currentAccountId.value
            val conversationId = _state.value.conversationId
            if (accountId != null && conversationId.isNotEmpty()) {
                jamiBridge.removeConversation(accountId, conversationId)
            }
        } catch (e: Exception) {
            _state.update { it.copy(error = "Failed to delete conversation: ${e.message}") }
        }
    }
}
```

**Usage**: Long-press on the contact name/avatar in the ChatScreen header to show the delete confirmation dialog.

---

## Fix 3: Message Author Detection (isFromMe)

### Problem
Messages sent by the user appeared on the wrong side of the screen (as received messages instead of sent messages) because the code compared:
- `msg.author` = Jami ID (e.g., `11f22a30a9efbf032c9eee05f98939e31bf0a412`)
- `accountId` = Account hash (e.g., `2078d1ac09712bfb`)

These are different identifiers, so all messages appeared as `isFromMe=false`.

### Solution
Updated the code to compare Jami IDs instead of account hashes by using the `jamiId` field from `AccountState`.

**Files Modified**:
- `shared/src/commonMain/kotlin/com/gettogether/app/presentation/state/ChatState.kt`
- `shared/src/commonMain/kotlin/com/gettogether/app/presentation/viewmodel/ChatViewModel.kt`

**Implementation**:

1. **Added userJamiId to ChatState**:
```kotlin
data class ChatState(
    val conversationId: String = "",
    val contactName: String = "",
    val userJamiId: String = "",  // ← Added this
    val messages: List<ChatMessage> = emptyList(),
    val messageInput: String = "",
    val isSending: Boolean = false,
    val error: String? = null
)
```

2. **Load userJamiId when loading conversation**:
```kotlin
fun loadConversation(conversationId: String) {
    viewModelScope.launch {
        val accountId = accountRepository.currentAccountId.value
        val userJamiId = accountRepository.accountState.value.jamiId  // ← Get Jami ID

        _state.update {
            it.copy(
                contactName = contactName,
                userJamiId = userJamiId  // ← Store in state
            )
        }
    }
}
```

3. **Updated isFromMe comparison**:
```kotlin
// Before: isFromMe = msg.author == accountId
// After: isFromMe = msg.author == userJamiId

is JamiConversationEvent.MessageReceived -> {
    val userJamiId = _state.value.userJamiId
    val newMessage = ChatMessage(
        id = event.message.id,
        content = messageBody,
        timestamp = formatTimestamp(event.message.timestamp),
        isFromMe = event.message.author == userJamiId,  // ← Fixed comparison
        status = MessageStatus.Sent
    )
}
```

**Result**: User's own messages now correctly appear on the right side in blue, while received messages appear on the left in gray.

---

## Testing

All three fixes have been implemented and built successfully. To test:

1. **Bottom Padding**: Open a chat and observe that the message input area respects the system navigation bar at the bottom
2. **Delete Conversation**: Long-press on the contact name in the ChatScreen header to show the delete dialog
3. **Message Bubbles**: Send a message and verify it appears on the right side in blue (user's message)

---

**Date**: 2025-12-20
**Build**: DEBUG
**Status**: ✅ All fixes completed and installed
